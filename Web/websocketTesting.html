<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Websocket Testing</title>
    <style>
        .lines, .lines th, .lines td {
            border: 1px solid black;
        }

        .lines {
            border-collapse: collapse;
            width: 100%;
            table-layout: fixed;
        }

        .lines td div {
            overflow-y: scroll;
            height: 300px;
            text-align: left;
            vertical-align: top;
            display: block;
        }
    </style>
</head>
<body>
<div id="main">
    <input id="url" type="text" value="localhost"/>
    <input id="openWSButton" type="button" value="Open connection" onclick="openWebSocket(config);"/>
    <input id="closeWSButton" type="button" value="Close connection" onclick="closeWebSocket();" disabled/>
    <table>
        <tr>
            <th>command</th>
            <th>data</th>
            <th></th>
        </tr>
        <tr>
            <td>build</td>
            <form id="buildForm">
                <td>
                    <input name="objectId" type="text" placeholder="objectId"/>
                    <input name="xPos" type="text" placeholder="xPos"/>
                    <input name="zPos" type="text" placeholder="zPos"/>
                </td>
                <td>
                    <input type="button" value="Send" onclick="sendBuildCommand();">
                </td>
            </form>
        </tr>
        <tr>
            <td>spawnMob</td>
            <form id="spawnMobForm">
                <td>
                    <input name="objectId" type="text" placeholder="objectId"/>
                    <input name="xPos" type="text" placeholder="xPos"/>
                    <input name="zPos" type="text" placeholder="zPos"/>
                    <input name="id" type="text" placeholder="id"/>
                </td>
                <td>
                    <input type="button" value="Send" onclick="sendSpawnMobCommand();">
                </td>
            </form>
        </tr>
    </table>
    <br>
</div>
<div id="footer">
    Update frequency: <span id="updateFrequency"></span><br>
    <label for="showMovement">Show movement in output</label>
    <input id="showMovement" type="checkbox" onclick="setShowMovement();">
    <br>
    <div>
        <input type="button" onclick="clearOutput();" value="Clear output"/>
        <table class="lines">
            <tr>
                <th>websocket</th>
                <th>worldStatus</th>
                <th>vrPosition</th>
                <th>mobPosition</th>
            </tr>
            <tr>
                <td><div id="wsUpdates"></div></td>
                <td><div id="worldStatusUpdates"></div></td>
                <td><div id="vrPositionUpdates"></div></td>
                <td><div id="mobPositionUpdates"></div></td>
            </tr>
        </table>
    </div>
</div>

<!-- Scripts -->
<script type="text/javascript" src="js/sockets/webSockets.js"></script>
<script type="text/javascript" src="js/sockets/unityClient.js"></script>
<script type="text/javascript" charset="UTF-8">
    var showMovement = false;
    var updateFrequency = 0;

    var config = {
        "onOpen": function () {
            writeToOutput("WebSocket opened.", "wsUpdates");
            document.getElementById("openWSButton").disabled = true;
            document.getElementById("closeWSButton").disabled = false;
        },
        "onMessage": {
            "worldStatus": function (msg) {
                for (var i = 0; i < msg.length; i++) {
                    writeToOutput("Room: " + msg[i].objectId + ", xPos: " + msg[i].xPos + ", zPos: " + msg[i].zPos, "worldStatusUpdates");
                }
            },
            "vrPosition": function (msg) {
                // By default (defined in Unity) this will be called 30x a second
                updateFrequency++;
                if (showMovement) {
                    writeToOutput("xPos: " + msg.xPos + ", zPos: " + msg.zPos, "vrPositionUpdates");
                }
            },
            "mobPositions": function (msg) {
                if (showMovement) {
                    for (var i = 0; i < msg.length; i++) {
                        writeToOutput("Mob: " + msg[i].objectId + ", xPos: " + msg[i].xPos + ", zPos: " + msg[i].zPos + ", id: " + msg[i].id, "mobPositionUpdates");
                    }
                }
            }
        },
        "onClose": function () {
            writeToOutput("WebSocket closed.", "wsUpdates");
            document.getElementById("openWSButton").disabled = false;
            document.getElementById("closeWSButton").disabled = true;
        }
    };

    window.onload = function () {
        if ("WebSocket" in window) {
            writeToOutput("WebSockets are available!", "wsUpdates");
        } else {
            alert("WebSockets are not supported in this browser");
        }
    };

    setInterval(function() {
        document.getElementById("updateFrequency").innerHTML = updateFrequency;
        updateFrequency = 0;
    }, 1000);

    function sendBuildCommand() {
        var buildForm = document.getElementById("buildForm").elements;
        UnityClient.buildCommand(buildForm[0].value, buildForm[1].value, buildForm[2].value);
    }

    function sendSpawnMobCommand() {
        var spawnMobForm = document.getElementById("spawnMobForm").elements;
        UnityClient.spawnMobCommand(spawnMobForm[0].value, spawnMobForm[1].value, spawnMobForm[2].value, spawnMobForm[3].value);
    }

    function writeToOutput(text, id) {
        var output = document.getElementById(id).innerHTML;

        document.getElementById(id).innerHTML = text + "<br>" + output;
    }

    function clearOutput() {
        document.getElementById("wsUpdates").innerHTML = "<br>";
        document.getElementById("worldStatusUpdates").innerHTML = "<br>";
        document.getElementById("vrPositionUpdates").innerHTML = "<br>";
        document.getElementById("mobPositionUpdates").innerHTML = "<br>";
    }

    function setShowMovement() {
        showMovement = document.getElementById("showMovement").checked;
    }

</script>
</body>
</html>