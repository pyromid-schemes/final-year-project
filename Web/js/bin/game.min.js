function getAccurateCoords(){var pointer=game.phaser.input.activePointer;return{x:pointer.x-1,y:pointer.y-2}}function isPointWithinRect(point,rect){return point.x>=rect.x&&point.y>=rect.y&&point.x<=rect.x+rect.w&&point.y<=rect.y+rect.h}function isPointWithinBoundingBox(point,rect){return point.x>=rect.x1&&point.y>=rect.y1&&point.x<=rect.x2&&point.y<=rect.y2}function isXYWithinBoundingBox(x,y,rect){return x>=rect.x1&&y>=rect.y1&&x<=rect.x2&&y<=rect.y2}var Tilemaps={chengy:{tilemapKey:"tilemap-chengy",tilemapPath:"assets/tilemaps/chengy-room.png"},lava:{tilemapKey:"tilemap-lava",tilemapPath:"assets/tilemaps/lava-room.png"},ghostRoom:{placeable:{tilemapKey:"tilemap-ghost-placeable",tilemapPath:"assets/tilemaps/placeable-room.png",suffix:"-placeable"},nonplaceable:{tilemapKey:"tilemap-ghost-nonplaceable",tilemapPath:"assets/tilemaps/non-placeable-room.png",suffix:"-nonplaceable"}}},Mobs={ant:{id:"mobKnight",sprite:{key:"mobs-ant",image:"assets/mobs/ant.png",size:{width:16,height:16}},builderButton:{key:"builder-button-mob-ant",image:"assets/buttons/mobs/ant.png"}},bear:{id:"bear",sprite:{key:"mobs-bear",image:"assets/mobs/bear.png",size:{width:16,height:16}},builderButton:{key:"builder-button-mob-bear",image:"assets/buttons/mobs/bear.png"}}},Player={id:"player",sprite:{key:"player-key",image:"assets/player/player.png",size:{width:16,height:16},center:{x:8,y:10}}},Rooms={chengy_room:{room_id:"room1",w:4,h:4,center:{x:1,y:1},data:[[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1]],data2:[["tl","tm","tm","tr"],["ml","mm","mm","mr"],["ml","mm","mm","mr"],["bl","bm","bm","br"]],tilemap:Tilemaps.chengy,builderButton:{image:"assets/buttons/button4.png",key:"builder-button-chengy"}},chengy_room_5x3:{room_id:"room3",w:5,h:3,center:{x:2,y:1},data:[[1,1,1,1,1],[2,1,1,1,2],[1,1,1,1,1]],data2:[["tl","tm","tm","tm","tr"],["mm","mm","mm","mm","mm"],["bl","bm","bm","bm","br"]],tilemap:Tilemaps.lava,builderButton:{image:"assets/buttons/lava-5x3.png",key:"builder-button-lava5x3"}},chengy_room4doors:{room_id:"room2",w:4,h:4,center:{x:1,y:1},data:[[1,2,2,1],[2,1,1,2],[2,1,1,2],[1,2,2,1]],data2:[["tl","mm","mm","tr"],["mm","mm","mm","mm"],["mm","mm","mm","mm"],["bl","mm","mm","br"]],tilemap:Tilemaps.chengy,builderButton:{image:"assets/buttons/chengy-room-4doors.png",key:"builder-button-chengy4doors"}},chengy_room_door_up:{room_id:"room4",w:4,h:4,center:{x:1,y:1},data:[[1,2,2,1],[1,1,1,1],[1,1,1,1],[1,1,1,1]],data2:[["tl","mm","mm","tr"],["ml","mm","mm","mr"],["ml","mm","mm","mr"],["bl","bm","bm","br"]],tilemap:Tilemaps.chengy,builderButton:{image:"assets/buttons/chengy-room-door-up.png",key:"builder-button-chengy-door-up"}},l_shape_room:{room_id:"room5",w:4,h:4,center:{x:1,y:1},data:[[1,1,1,1],[1,1,1,2],[1,1,0,0],[1,2,0,0]],data2:[["tl","tm","tm","tr"],["ml","mm","bm","bm"],["ml","mr","",""],["bl","mr","",""]],tilemap:Tilemaps.chengy,builderButton:{image:"assets/buttons/l-room.png",key:"builder-button-l-room"}},room_6by6:{w:6,h:6,center:{x:2,y:2},data:[[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1]]}},Builder={game:null,buttons:{},mobButtons:{},tile_selector:null,which_tile_to_place:-1,create:function(GameObject){this.game=GameObject,game.graphics.beginFill(14443363,1),game.graphics.drawRect(game.builderView.x,game.builderView.y,game.builderView.w,game.builderView.h),game.graphics.endFill(),this.createButton(600,40,Rooms.chengy_room),this.createButton(600,80,Rooms.chengy_room4doors),this.createButton(640,40,Rooms.chengy_room_5x3),this.createButton(640,80,Rooms.chengy_room_door_up),this.createButton(680,40,Rooms.l_shape_room),this.createMobButton(600,160,Mobs.ant),this.createMobButton(640,160,Mobs.bear),this.tile_selector=game.phaser.add.sprite(0,0,"builder-button-selector"),this.tile_selector.alpha=0},createButton:function(x,y,room){var btn=game.phaser.add.sprite(x,y,room.builderButton.key);btn.inputEnabled=!0,btn.events.onInputDown.add(this.listener,this),this.buttons[room.builderButton.key]={tile:btn,room_id:room.room_id}},createMobButton:function(x,y,mob_button){var btn=game.phaser.add.sprite(x,y,mob_button.builderButton.key);btn.inputEnabled=!0,btn.events.onInputDown.add(this.listener,this),this.mobButtons[mob_button.builderButton.key]={tile:btn,mob_id:mob_button.id}},listener:function(){var sprite=arguments[0],key=sprite.key;return this.which_tile_to_place==key?this.unselectTile():void this.selectTile(key)},isPlacingSomething:function(){return this.which_tile_to_place!=-1},isPlacingRoom:function(){return this.isPlacingSomething()&&"room"==this.typeOfTileToPlace},isPlacingMob:function(){return this.isPlacingSomething()&&"mob"==this.typeOfTileToPlace},getActiveButton:function(){return"room"==this.typeOfTileToPlace?this.game.builderObject.buttons[this.game.builderObject.which_tile_to_place]:"mob"==this.typeOfTileToPlace?this.game.builderObject.mobButtons[this.game.builderObject.which_tile_to_place]:null},selectTile:function(key){var obj;if(key in this.buttons)obj=this.buttons[key],this.typeOfTileToPlace="room";else{if(!(key in this.mobButtons))throw new Error("Error selecting tile with key ["+key+"]");obj=this.mobButtons[key],this.typeOfTileToPlace="mob"}this.tile_selector.x=obj.tile.x-2,this.tile_selector.y=obj.tile.y-2,this.tile_selector.alpha=1,this.which_tile_to_place=key},unselectTile:function(){this.tile_selector.alpha=0,this.which_tile_to_place=-1,this.game.mapObject.redrawEverything()},keyOnDown:function(e){"Escape"==e.key&&this.unselectTile()}},game={phaser:null,start:function(){this.phaser=new Phaser.Game(800,600,Phaser.AUTO,"game",{preload:this.preload,create:this.create,update:this.update,render:this.render})},mapObject:null,builderObject:null,propertyObject:null,mapView:null,builderView:null,propertyView:null,invalidated:!1,redraws:0,preload:function(){game.phaser.load.image(Rooms.chengy_room.builderButton.key,Rooms.chengy_room.builderButton.image),game.phaser.load.image(Rooms.chengy_room4doors.builderButton.key,Rooms.chengy_room4doors.builderButton.image),game.phaser.load.image(Rooms.chengy_room_5x3.builderButton.key,Rooms.chengy_room_5x3.builderButton.image),game.phaser.load.image(Rooms.chengy_room_door_up.builderButton.key,Rooms.chengy_room_door_up.builderButton.image),game.phaser.load.image(Rooms.l_shape_room.builderButton.key,Rooms.l_shape_room.builderButton.image),game.phaser.load.image(Mobs.ant.builderButton.key,Mobs.ant.builderButton.image),game.phaser.load.image(Mobs.bear.builderButton.key,Mobs.bear.builderButton.image),game.phaser.load.image("builder-button-selector","assets/buttons/selector.png"),game.phaser.load.image("tile-empty-16","assets/buttons/empty-tile-16.png"),game.phaser.load.atlas(Tilemaps.chengy.tilemapKey,Tilemaps.chengy.tilemapPath,"assets/tilemaps/tilemap.json"),game.phaser.load.atlas(Tilemaps.lava.tilemapKey,Tilemaps.lava.tilemapPath,"assets/tilemaps/tilemap.json"),game.phaser.load.atlas(Tilemaps.ghostRoom.placeable.tilemapKey,Tilemaps.ghostRoom.placeable.tilemapPath,"assets/tilemaps/tilemap.json"),game.phaser.load.atlas(Tilemaps.ghostRoom.nonplaceable.tilemapKey,Tilemaps.ghostRoom.nonplaceable.tilemapPath,"assets/tilemaps/tilemap.json"),game.phaser.load.image(Mobs.ant.sprite.key,Mobs.ant.sprite.image),game.phaser.load.image(Mobs.bear.sprite.key,Mobs.bear.sprite.image),game.phaser.load.image(Player.sprite.key,Player.sprite.image)},create:function(){var graphics=game.phaser.add.graphics(0,0);window.graphics=graphics,game.graphics=graphics,game.mapView={x:0,y:0,w:550,h:500},game.builderView={x:550,y:0,w:250,h:600},game.propertyView={x:0,y:500,w:550,h:100},game.mapObject=Map,game.mapObject.create(game),game.builderObject=Builder,game.builderObject.create(game),game.propertyObject=Property,game.propertyObject.create(game),game.phaser.input.onDown.add(game.onDown,this),game.phaser.input.onUp.add(game.onUp,this),game.phaser.input.addMoveCallback(game.onMove,this),game.phaser.input.addMoveCallback(game.onMove,this),game.phaser.input.keyboard.onDownCallback=game.keyOnDown,game.phaser.canvas.oncontextmenu=function(e){e.preventDefault()}},update:function(){},render:function(){game.invalidated&&(game.invalidated=!1,game.mapObject.render())},onDown:function(e){var mouseCoords=getAccurateCoords();isPointWithinRect(mouseCoords,game.mapView)&&game.mapObject.onDown(e)},onUp:function(e){game.mapObject.onUp(e)},onMove:function(e){game.mapObject.onMove(e)},keyOnDown:function(e){game.mapObject.keyOnDown(e),game.builderObject.keyOnDown(e)},sendMessage:function(messageType,data){switch(messageType){case"create-mob":UnityClient.spawnMobCommand(data.objectId,data.xPos,data.zPos,data.id);break;case"create-room":UnityClient.buildCommand(data.objectId,data.xPos,data.yPos)}},worldStatusUpdate:function(msg){game.mapObject.removeAllRooms();for(var i=0;i<msg.length;i++)game.mapObject.placeRoomAtBottomLeft(msg[i].objectId,msg[i].xPos,msg[i].zPos,!1);game.mapObject.redrawEverything()},vrPositionUpdate:function(msg){game.mapObject.setPlayerPosition(msg)},mobPositionUpdate:function(msg){game.mapObject.updateMobPosition(msg)}};window.addEventListener("load",function(){game.start(),window.game=game});var Map={game:null,map:null,mapDimensions:null,mapRooms:[],roomTypes:{},roomRendersCache:{},tileMapTypes:{},emptyTile:null,emptyTileBackground:null,mapScrollOffsetX:0,mapScrollOffsetY:0,dragCurrentX:0,dragCurrentY:0,isDragging:!1,ghostRoomX:-1,ghostRoomY:-1,player:null,mobTypes:{},mapMobs:[],debug_mob_ant:null,MAP_WIDTH:33,MAP_HEIGHT:30,TILE_SIZE:16,MAP_DRAW_OFFSET_X:10,MAP_DRAW_OFFSET_Y:10,create:function(GameObject){this.game=GameObject,this.game.graphics.beginFill(11920362,1),this.game.graphics.drawRect(this.game.mapView.x,this.game.mapView.y,this.game.mapView.w,this.game.mapView.h),this.game.graphics.endFill(),this.setupMap(),this.setupTiledBackground(),this.createTilemap(Tilemaps.chengy.tilemapKey),this.createTilemap(Tilemaps.lava.tilemapKey),this.createTilemap(Tilemaps.ghostRoom.placeable.tilemapKey),this.createTilemap(Tilemaps.ghostRoom.nonplaceable.tilemapKey),this.addRoom(Rooms.chengy_room),this.addRoom(Rooms.chengy_room4doors),this.addRoom(Rooms.chengy_room_5x3),this.addRoom(Rooms.chengy_room_door_up),this.addRoom(Rooms.l_shape_room),this.addMob(Mobs.ant),this.addMob(Mobs.bear),this.setupPlayer(Player),this.mapScrollOffsetX+=272,this.mapScrollOffsetY+=240,this.placeRoomAtBottomLeft(Rooms.chengy_room4doors.room_id,0,0,!1),this.placeRoomAtBottomLeft(Rooms.chengy_room4doors.room_id,0,-4,!1),this.setPlayerPosition({xPos:2,zPos:-2}),this.placeMob(Mobs.ant.id,{x:1.5*this.TILE_SIZE,y:-6.5*this.TILE_SIZE},!1),this.game.invalidated=!0},setupMap:function(){var map_world_width=this.MAP_WIDTH*this.TILE_SIZE,map_world_height=this.MAP_HEIGHT*this.TILE_SIZE,map_bg_black=game.phaser.make.bitmapData(map_world_width,map_world_height);map_bg_black.rect(0,0,map_world_width,map_world_height,"#000"),this.mapDimensions={x:this.MAP_DRAW_OFFSET_X,y:this.MAP_DRAW_OFFSET_Y,w:map_world_width,h:map_world_height};var map_bg_width=map_world_width+2,map_bg_height=map_world_height+2,map_bg_red_border=game.phaser.make.bitmapData(map_bg_width,map_bg_height);map_bg_red_border.rect(0,0,map_bg_width,map_bg_height,"#f00"),game.phaser.add.sprite(this.MAP_DRAW_OFFSET_X-1,this.MAP_DRAW_OFFSET_Y-1,map_bg_red_border),game.phaser.add.sprite(this.MAP_DRAW_OFFSET_X,this.MAP_DRAW_OFFSET_Y,map_bg_black),this.map=this.game.phaser.add.renderTexture(map_world_width,map_world_height,"map"),this.game.phaser.add.sprite(this.MAP_DRAW_OFFSET_X,this.MAP_DRAW_OFFSET_Y,this.map)},setupTiledBackground:function(){this.emptyTile=game.phaser.make.sprite(0,0,"tile-empty-16");for(var tiled_background=game.phaser.make.renderTexture((this.MAP_WIDTH+1)*this.TILE_SIZE,(this.MAP_HEIGHT+1)*this.TILE_SIZE,"empty-tiled-background"),x=0;x<this.MAP_WIDTH+1;x++)for(var y=0;y<this.MAP_HEIGHT+1;y++)tiled_background.renderRawXY(this.emptyTile,x*this.TILE_SIZE,y*this.TILE_SIZE);this.emptyTileBackground=this.game.phaser.make.image(0,0,tiled_background),this.renderEmptyTileBackground()},setupPlayer:function(player){var sprite=game.phaser.make.sprite(0,0,player.sprite.key);this.player={sprite:sprite,position:{x:0,y:0},size:player.sprite.size,center:player.sprite.center,is_visible:!0}},addRoom:function(room_data){this.roomTypes[room_data.room_id]={dimensions:room_data};for(var tileMapKeys=[{tilemap:room_data.tilemap.tilemapKey,key_suffix:""},{tilemap:Tilemaps.ghostRoom.placeable.tilemapKey,key_suffix:Tilemaps.ghostRoom.placeable.suffix},{tilemap:Tilemaps.ghostRoom.nonplaceable.tilemapKey,key_suffix:Tilemaps.ghostRoom.nonplaceable.suffix}],i=0;i<tileMapKeys.length;i++){for(var tilemap_temp=tileMapKeys[i],key=room_data.room_id+tilemap_temp.key_suffix,room_cache=game.phaser.make.renderTexture(room_data.w*this.TILE_SIZE,room_data.h*this.TILE_SIZE,key),y=0;y<room_data.data2.length;y++)for(var x=0;x<room_data.data2[y].length;x++){var tile_data=room_data.data2[y][x];""!=tile_data&&room_cache.renderRawXY(this.tileMapTypes[tilemap_temp.tilemap][tile_data],x*this.TILE_SIZE,y*this.TILE_SIZE)}this.roomRendersCache[key]=this.game.phaser.make.image(0,0,room_cache)}},addMob:function(mob){this.mobTypes[mob.id]={mob:mob,render:this.game.phaser.make.sprite(0,0,mob.sprite.key)}},createTilemap:function(tilemap_key){this.tileMapTypes[tilemap_key]={};for(var tilemap_positions=["tl","tm","tr","mr","br","bm","bl","ml","mm"],i=0;i<tilemap_positions.length;i++)this.tileMapTypes[tilemap_key][tilemap_positions[i]]=game.phaser.make.sprite(0,0,tilemap_key),this.tileMapTypes[tilemap_key][tilemap_positions[i]].frameName=tilemap_positions[i]},renderEmptyTileBackground:function(){this.map.clear();var offset=this.getMapDrawOffset();offset.x-=this.TILE_SIZE,offset.y-=this.TILE_SIZE,this.map.renderRawXY(this.emptyTileBackground,offset.x,offset.y)},renderAllRooms:function(){for(var i=0;i<this.mapRooms.length;i++){var r=this.mapRooms[i],render_x=r.x*this.TILE_SIZE+this.mapScrollOffsetX,render_y=r.y*this.TILE_SIZE+this.mapScrollOffsetY;this.map.renderRawXY(this.roomRendersCache[r.room_id],render_x,render_y)}},renderGhostRoom:function(){if(this.isMouseInsideMap())if(this.game.builderObject.which_tile_to_place!=-1&&"mob"==this.game.builderObject.typeOfTileToPlace){var btn=this.game.builderObject.mobButtons[this.game.builderObject.which_tile_to_place],mob_id=btn.mob_id,mob=this.mobTypes[mob_id],tile=this.getTileFromMouseXY(),mouse=getAccurateCoords();mouse.x-=this.MAP_DRAW_OFFSET_X,mouse.y-=this.MAP_DRAW_OFFSET_Y,mouse.x-=8,mouse.y-=8,this.map.renderRawXY(mob.render,mouse.x,mouse.y)}else if(this.game.builderObject.which_tile_to_place!=-1&&"room"==this.game.builderObject.typeOfTileToPlace){var btn=this.game.builderObject.buttons[this.game.builderObject.which_tile_to_place],room_id=btn.room_id,room=this.roomTypes[room_id],tile=this.getTileFromMouseXY(),draw_x=(tile.x-room.dimensions.center.x)*this.TILE_SIZE+this.mapScrollOffsetX,draw_y=(tile.y-room.dimensions.center.y)*this.TILE_SIZE+this.mapScrollOffsetY;this.canPlaceRoom(room_id,tile.x,tile.y)?this.map.renderRawXY(this.roomRendersCache[room_id+Tilemaps.ghostRoom.placeable.suffix],draw_x,draw_y):this.map.renderRawXY(this.roomRendersCache[room_id+Tilemaps.ghostRoom.nonplaceable.suffix],draw_x,draw_y)}},renderPlayer:function(){var draw_x=this.player.position.x-this.player.center.x+this.mapScrollOffsetX,draw_y=this.player.position.y-this.player.center.y+this.mapScrollOffsetY;this.map.renderRawXY(this.player.sprite,draw_x,draw_y)},renderMobs:function(){for(var i=0;i<this.mapMobs.length;i++){var mob=this.mapMobs[i],render_x=mob.x+this.mapScrollOffsetX,render_y=mob.y+this.mapScrollOffsetY;this.map.renderRawXY(mob.mob_type.render,render_x,render_y)}},redrawEverything:function(){this.game.invalidated=!0},render:function(){this.renderEmptyTileBackground(),this.renderAllRooms(),this.renderMobs(),this.renderPlayer(),this.renderGhostRoom(),this.game.redraws+=1,document.getElementById("redraw-count").innerHTML=this.game.redraws},onDown:function(e){if(this.isMouseInsideMap())if(this.game.builderObject.isPlacingMob()){var btn=this.game.builderObject.getActiveButton(),mob=this.mobTypes[btn.mob_id];console.log("place mob"),console.log(btn.mob_id);var pos=this.getMobPosXY(mob.mob.sprite.size);this.canPlaceMob(btn.mob_id,pos)&&this.placeMob(btn.mob_id,pos,!0)}else if(this.game.builderObject.isPlacingRoom()){var btn=this.game.builderObject.buttons[this.game.builderObject.which_tile_to_place],tile=this.getTileFromMouseXY();this.canPlaceRoom(btn.room_id,tile.x,tile.y)&&this.placeRoom(btn.room_id,tile.x,tile.y,!0)}else{this.isDragging=!0;var pointer=this.game.phaser.input.activePointer;this.dragCurrentX=pointer.x,this.dragCurrentY=pointer.y}},onUp:function(e){this.isDragging&&(this.isDragging=!1)},onMove:function(e){if(this.isDragging){var pointer=this.game.phaser.input.activePointer,difference_x=this.dragCurrentX-pointer.x,difference_y=this.dragCurrentY-pointer.y;this.dragCurrentX=pointer.x,this.dragCurrentY=pointer.y,this.mapScrollOffsetX-=difference_x,this.mapScrollOffsetY-=difference_y,this.redrawEverything()}else if(this.game.builderObject.which_tile_to_place!=-1)if(this.isMouseInsideMap()){if("mob"==this.game.builderObject.typeOfTileToPlace)this.redrawEverything();else if("room"==this.game.builderObject.typeOfTileToPlace){var tile=this.getTileFromMouseXY();this.ghostRoomX==tile.x&&this.ghostRoomY==tile.y||(this.ghostRoomX=tile.x,this.ghostRoomY=tile.y,this.redrawEverything())}}else this.ghostRoomX==-1&&this.ghostRoomY==-1||(this.ghostRoomX=-1,this.ghostRoomY=-1,this.redrawEverything())},keyOnDown:function(e){"r"==e.key},canPlaceMob:function(mob_id,position){for(var i=(this.mobTypes[mob_id],0);i<this.mapRooms.length;i++){var r=this.mapRooms[i];if(isXYWithinBoundingBox(position.x,position.y,r.abs_bb))return!0}return!1},placeMob:function(mob_id,position,send_message){var mob_type=this.mobTypes[mob_id],map_mob_id=this.mapMobs.length,center={x:position.x+mob_type.mob.sprite.size.width/2,y:position.y+mob_type.mob.sprite.size.height/2},unity_position={x:center.x/this.TILE_SIZE,y:center.y/this.TILE_SIZE};if(this.mapMobs[map_mob_id]={id:map_mob_id,mob_id:mob_id,x:position.x,y:position.y,center:center,mob_type:mob_type,unity_position:unity_position},send_message){var data={objectId:mob_id,xPos:unity_position.x,zPos:unity_position.y,id:map_mob_id};this.game.sendMessage("create-mob",data)}},canPlaceRoom:function(room_id,x,y){for(var room=this.roomTypes[room_id],bounding_box=this.getBoundingBoxForRoom(x,y,room),i=0;i<this.mapRooms.length;i++){var r=this.mapRooms[i];if(this.doesBoundingBoxesCollide(bounding_box,r.bb))return!1}return!0},placeRoomAtTopLeft:function(room_id,x,y,send_message){var room=this.roomTypes[room_id];this.placeRoom(room_id,x+room.dimensions.center.x,y+room.dimensions.center.y,send_message)},placeRoomAtBottomLeft:function(room_id,x,y,send_message){var room=this.roomTypes[room_id];this.placeRoomAtTopLeft(room_id,x,y-room.dimensions.h,send_message)},placeRoom:function(room_id,x,y,send_message){var room=this.roomTypes[room_id],map_room_id=this.mapRooms.length,bounding_box=this.getBoundingBoxForRoom(x,y,room),absolute_bb=this.getAbsBoundingBoxForRoom(x,y,room);if(this.mapRooms[map_room_id]={room_id:room_id,x:x-room.dimensions.center.x,y:y-room.dimensions.center.y,x2:x,y2:y,bb:bounding_box,abs_bb:absolute_bb,room:room},send_message){var data={objectId:room_id,xPos:x-room.dimensions.center.x,yPos:y-room.dimensions.center.y+room.dimensions.h};this.game.sendMessage("create-room",data)}this.game.invalidated=!0},setPlayerPosition:function(msg){this.player.position.x=msg.xPos*this.TILE_SIZE,this.player.position.y=msg.zPos*this.TILE_SIZE,this.game.invalidated=!0},updateMobPosition:function(msg){console.log("updateMobPosition:"),console.log(msg);var mob=this.mapMobs[msg.id],mob_type=this.mobTypes[mob.mob_id];mob.unity_position={x:msg.xPos,y:msg.zPos},mob.center={x:msg.xPos*this.TILE_SIZE,y:msg.zPos*this.TILE_SIZE};var top_left={x:center.x-mob_type.mob.sprite.size.width/2,y:center.y-mob_type.mob.sprite.size.height/2};mob.x=top_left.x,mob.y=top_left.y,this.mapMobs[msg.id]=mob,this.game.invalidated=!0},removeAllRooms:function(){for(;this.mapRooms.length;)this.mapRooms.pop()},getMapDrawOffset:function(){var x=this.mapScrollOffsetX%this.TILE_SIZE,y=this.mapScrollOffsetY%this.TILE_SIZE;return{x:x<0?x+this.TILE_SIZE:x,y:y<0?y+this.TILE_SIZE:y}},getTileFromMouseXY:function(){var mouse=getAccurateCoords();return{x:Math.floor((mouse.x-this.MAP_DRAW_OFFSET_X-this.mapScrollOffsetX)/this.TILE_SIZE),y:Math.floor((mouse.y-this.MAP_DRAW_OFFSET_Y-this.mapScrollOffsetY)/this.TILE_SIZE)}},getMobPosXY:function(mob_size){var mouse=getAccurateCoords();return mouse.x-=this.MAP_DRAW_OFFSET_X+mob_size.width/2+this.mapScrollOffsetX,mouse.y-=this.MAP_DRAW_OFFSET_Y+mob_size.height/2+this.mapScrollOffsetY,mouse},doesBoundingBoxesCollide:function(bb1,bb2){return!(bb2.x1>bb1.x2||bb2.x2<bb1.x1||bb2.y1>bb1.y2||bb2.y2<bb1.y1)},getBoundingBoxForRoom:function(x,y,room){var top_left_x=x-room.dimensions.center.x,top_left_y=y-room.dimensions.center.y,bottom_right_x=top_left_x+room.dimensions.w-1,bottom_right_y=top_left_y+room.dimensions.h-1;return{x1:top_left_x,y1:top_left_y,x2:bottom_right_x,y2:bottom_right_y}},getAbsBoundingBoxForRoom:function(x,y,room){var bb=this.getBoundingBoxForRoom(x,y,room);return bb.x1*=16,bb.y1*=16,bb.x2*=16,bb.y2*=16,bb},isMouseInsideMap:function(){var mouse=getAccurateCoords();return isPointWithinRect(mouse,this.mapDimensions)},unityToWorldCoords:function(unityCoord){return unityCoord*this.TILE_SIZE}},Property={game:null,create:function(GameObject){this.game=GameObject,game.graphics.beginFill(3522888,1),game.graphics.drawRect(game.propertyView.x,game.propertyView.y,game.propertyView.w,game.propertyView.h),game.graphics.endFill()}};